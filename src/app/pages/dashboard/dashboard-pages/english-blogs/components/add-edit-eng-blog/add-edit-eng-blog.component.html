<ngx-spinner
  name="actionsLoader"
  bdColor="rgba(0, 0, 0, 0.8)"
  size="medium"
  color="#fff"
  type="square-spin"
  [fullScreen]="true">
  <p style="color: white">Loading...</p>
</ngx-spinner>

<div class="card">
  <h2 class="card-title">{{ isEditMode ? 'Edit English Blog' : 'Add New English Blog' }}</h2>

  <form [formGroup]="blogForm" (ngSubmit)="onSubmit()" class="blog-form">
    <div class="form-section">
      <h3 class="section-title">Blog Title</h3>
      <div class="form-row">
        <div class="form-field">
          <label for="en_blog_title" class="field-label">English Blog Title</label>
          <div class="input-container">
            <input
              pInputText
              id="en_blog_title"
              formControlName="en_blog_title"
              placeholder="Enter English Blog Title"
              [ngClass]="{'p-invalid': blogForm.get('en_blog_title')?.touched && blogForm.get('en_blog_title')?.invalid}"
              [disabled]="isSubmitting"
            />
          </div>
          <div class="error-container">
            @if (blogForm.get('en_blog_title')?.touched && blogForm.get('en_blog_title')?.hasError('required')) {
              <small class="error-message">English Blog Title is required</small>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="section-title">Blog Content</h3>
      <div class="form-row">
        <div class="form-field">
          <label for="en_blog_text" class="field-label">English Blog Content</label>
          <ngx-jodit
            dir="ltr"
            [options]="{ language: 'en', direction: 'ltr', height: 400 }"
            formControlName="en_blog_text"
            class="rich-text-content"
            [ngClass]="{'p-invalid': blogForm.get('en_blog_text')?.touched && blogForm.get('en_blog_text')?.invalid}"
            [attr.disabled]="isSubmitting ? true : null"
          ></ngx-jodit>
          <div class="error-container">
            @if (blogForm.get('en_blog_text')?.touched && blogForm.get('en_blog_text')?.hasError('required')) {
              <small class="error-message">English Blog Content is required</small>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="section-title">Meta Information</h3>
      <div class="form-row">
        <div class="form-field">
          <label for="en_meta_title" class="field-label">English Meta Title</label>
          <div class="input-container">
            <input
              pInputText
              id="en_meta_title"
              formControlName="en_meta_title"
              placeholder="Enter English Meta Title"
              [ngClass]="{'p-invalid': blogForm.get('en_meta_title')?.touched && blogForm.get('en_meta_title')?.invalid}"
              [disabled]="isSubmitting"
            />
          </div>
          <div class="error-container">
            @if (blogForm.get('en_meta_title')?.touched && blogForm.get('en_meta_title')?.hasError('required')) {
              <small class="error-message">English Meta Title is required</small>
            }
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-field">
          <label for="en_meta_text" class="field-label">English Meta Description</label>
          <textarea
            pInputTextarea
            id="en_meta_text"
            formControlName="en_meta_text"
            rows="7"
            placeholder="Enter English Meta Description"
            [ngClass]="{'p-invalid': blogForm.get('en_meta_text')?.touched && blogForm.get('en_meta_text')?.invalid}"
            [disabled]="isSubmitting"
          ></textarea>
          <div class="error-container">
            @if (blogForm.get('en_meta_text')?.touched && blogForm.get('en_meta_text')?.hasError('required')) {
              <small class="error-message">English Meta Description is required</small>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="section-title">Script Text</h3>
      <div class="form-row">
        <div class="form-field">
          <label for="en_first_script_text" class="field-label">English First Script Text</label>
          <textarea
            pInputTextarea
            id="en_first_script_text"
            formControlName="en_first_script_text"
            rows="7"
            placeholder="Enter English First Script Text"
            [ngClass]="{'p-invalid': blogForm.get('en_first_script_text')?.touched && blogForm.get('en_first_script_text')?.invalid}"
            [disabled]="isSubmitting"
          ></textarea>
          <div class="error-container">
            @if (blogForm.get('en_first_script_text')?.touched && blogForm.get('en_first_script_text')?.hasError('required')) {
              <small class="error-message">English First Script Text is required</small>
            }
          </div>
        </div>

        <div class="form-field">
          <label for="en_second_script_text" class="field-label">English Second Script Text</label>
          <textarea
            pInputTextarea
            id="en_second_script_text"
            formControlName="en_second_script_text"
            rows="7"
            placeholder="Enter English Second Script Text"
            [ngClass]="{'p-invalid': blogForm.get('en_second_script_text')?.touched && blogForm.get('en_second_script_text')?.invalid}"
            [disabled]="isSubmitting"
          ></textarea>
          <div class="error-container">
            @if (blogForm.get('en_second_script_text')?.touched && blogForm.get('en_second_script_text')?.hasError('required')) {
              <small class="error-message">English Second Script Text is required</small>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="section-title">Additional Details</h3>
      <div class="form-row flex items-center">
        <div class="form-field" *ngIf="!isEditMode">
          <label for="blog_date" class="field-label">Blog Date</label>
          <div class="input-container">
            <input
              type="date"
              pInputText
              id="blog_date"
              formControlName="blog_date"
              [min]="!isEditMode ? minDate : null"
              [ngClass]="{'p-invalid': blogForm.get('blog_date')?.touched && blogForm.get('blog_date')?.invalid}"
              [disabled]="isSubmitting"
            />
          </div>
          <div class="error-container">
            @if (blogForm.get('blog_date')?.touched && blogForm.get('blog_date')?.hasError('required')) {
              <small class="error-message">Blog Date is required</small>
            }
            @if (!isEditMode && blogForm.get('blog_date')?.touched && blogForm.get('blog_date')?.hasError('pastDate')) {
              <small class="error-message">Selected date is in the past. Please choose today or a future date.</small>
            }
          </div>
        </div>

        <div class="form-field">
          <label for="active_status" class="field-label">Status</label>
          <div class="status-container">
            <p-inputSwitch
              id="active_status"
              formControlName="active_status"
              [trueValue]="true"
              [falseValue]="false"
              (onChange)="onActiveStatusChange($event)"
              [disabled]="isSubmitting"
            ></p-inputSwitch>
            <span class="status-label">{{ blogForm.get('active_status')?.value === true ? 'Active' : 'Inactive' }}</span>
          </div>
          <div class="error-container">
            @if (blogForm.get('active_status')?.touched && blogForm.get('active_status')?.hasError('required')) {
              <small class="error-message">Status is required</small>
            }
          </div>
        </div>
      </div>

      <div class="form-field">
        <label class="field-label">Main Image</label>
        <app-image-upload
          [initialImages]="initialImages"
          [singleImageMode]="true"
          [id]="'main'"
          (imagesChanged)="onImagesChanged($event)"
        ></app-image-upload>
        <div class="error-container">
          @if (blogForm.get('main_image')?.touched && blogForm.get('main_image')?.hasError('required')) {
            <small class="error-message">Main Image is required</small>
          }
        </div>
      </div>
    </div>

    <div class="flex justify-between items-center">
      <p-button
        type="button"
        label="Cancel"
        styleClass="p-button-text p-button-secondary"
        [routerLink]="['/dashboard/menu/en-blogs']"
        [disabled]="isSubmitting"
      ></p-button>
      <button
        type="submit"
        [disabled]="blogForm.invalid || isSubmitting"
        class="btn-main"
      >{{ isEditMode ? isSubmitting ? 'Updating...' : 'Update Blog' : isSubmitting ? 'Creating...' : 'Create Blog' }}</button>
    </div>
  </form>
</div>

@if (message.text) {
    <div [ngClass]="{
      'bg-green-100 border-green-400 text-green-700': message.type === 'success',
      'bg-red-100 border-red-400 text-red-700': message.type === 'error'
    }" class="border px-4 py-3 rounded relative mb-4" role="alert">
      <strong class="font-bold">{{ message.type === 'success' ? 'Success!' : 'Error!' }}</strong>
      <span class="block sm:inline ml-2">{{ message.text }}</span>
    </div>
  }